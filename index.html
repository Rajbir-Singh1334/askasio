<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PranAI - AI Image Generation</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Clerk Frontend SDK -->
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_ZXBpYy1haXJlZGFsZS02MS5jbGVyay5hY2NvdW50cy5kZXYk"
        src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
    </script>

    <style>
        :root {
            --color-dark-bg: #1c152e; /* Slightly darker than original */
            --color-panel-bg: #2b283d;
            --color-primary: #ecddfa;
            --color-primary-dark: #9333ea;
            --color-text-light: #d1d5db;
            --color-border: #4b4864;
            --transition-fast: 0.3s ease;
            --transition-slow: 0.6s ease;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--color-dark-bg);
            margin: 0;
            padding: 0;
            color: var(--color-text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Mobile Tab Styles */
        @media (min-width: 768px) {
            .bottom-tabs { display: none !important; }
            #sidebar { display: flex !important; }
            #imageArea { display: flex !important; }
        }
        @media (max-width: 767px) {
            #sidebar { display: flex; }
            #imageArea { display: none; }
            #sidebar, #imageArea {
                display: none;
            }
            #sidebar.active, #imageArea.active {
                display: flex !important;
            }
            .bottom-tabs { display: flex; }
        }
        .bottom-tabs button.active {
            color: white !important;
            background-color: var(--color-primary-dark);
        }
        .bottom-tabs button {
            transition: background var(--transition-fast), color var(--transition-fast);
            border-radius: 6px;
        }
        body:not(.light-mode) .bottom-tabs button {
            color: var(--color-text-light);
        }
        body.light-mode .bottom-tabs button {
            color: black;
        }
        /* Loading & Image */
        .loading-spinner {
            border-width: 6px;
            border-style: solid;
            border-color: rgba(255,255,255,0.2);
            border-top-color: var(--color-primary);
        }
        #generatedImage {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.7);
        }
        /* Light Mode Styles */
        body.light-mode {
            background: #f3f4f6;
            color: #1f2937;
        }
        body.light-mode .sidebar, body.light-mode #imageArea, body.light-mode header, body.light-mode .bottom-tabs {
            background: #ffffff;
        }
        body.light-mode #promptInput {
            background: #ffffff;
            color: #111827;
            border-color: #d1d5db;
        }
        body.light-mode #placeholderText {
            color: #6b7280;
        }
        body.light-mode #generateBtn {
            background: linear-gradient(to right, #6366f1, #4f46e5);
        }
        body.light-mode #copyPromptBtn {
            color: #4f46e5;
        }
        body.light-mode .image-display {
            border-color: #d1d5db;
        }
        body.light-mode #errorMessage {
            color: #dc2626;
        }
        body.light-mode #themeToggle {
            background: #e5e7eb;
            color: #1f2937;
        }
        body.light-mode #themeToggle:hover {
            background: #d1d5db;
        }
        /* Landing Page Custom Styles */
        #ctaBtn {
            animation: pulse-shadow 2s infinite ease-in-out;
        }
        @keyframes pulse-shadow {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); }
            50% { transform: scale(1.03); box-shadow: 0 0 25px 5px rgba(147, 51, 234, 0.9); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="flex justify-between items-center p-4 bg-[var(--color-panel-bg)] shadow-xl z-10 sticky top-0">
        <h1 class="text-2xl font-extrabold text-[var(--color-primary)]">PranAI</h1>
        <div class="flex items-center gap-4">
            <!-- User button is mounted here regardless of login status -->
            <div id="clerk-user-button"></div>
        </div>
    </header>

    <!-- NEW: Landing Page (Default public view) -->
    <div id="landing-page" class="flex-1 flex flex-col justify-center items-center p-8 text-center bg-[var(--color-dark-bg)]">
        <div class="max-w-3xl">
            <h1 class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-fuchsia-400 to-pink-500 mb-6 drop-shadow-xl">
                PranAI
            </h1>
            <p class="text-2xl md:text-3xl text-gray-300 mb-8 font-light">
                Unleash your imagination. Generate stunning, high-definition art with the power of AI.
            </p>
            <p class="text-lg text-gray-400 mb-12">
                From futuristic cities to ethereal landscapes, PranAI brings your most descriptive prompts to life.
            </p>
            <button id="ctaBtn" class="py-4 px-12 rounded-full text-xl font-bold text-white shadow-xl
                bg-gradient-to-r from-purple-600 to-fuchsia-600 hover:from-purple-700 hover:to-fuchsia-700
                transition-all duration-300">
                Start Creating Now
            </button>
        </div>
    </div>

    <!-- Auth Container (Only shown after CTA click if not logged in) -->
    <div id="auth-container" class="flex-1 hidden flex justify-center items-center p-8">
        <div id="clerk-sign-in-form"></div>
    </div>

    <!-- Protected Content (only visible when logged in) -->
    <main id="protected-content" class="flex-1 hidden">
        <div class="main-layout flex flex-col md:flex-row gap-4 p-4 md:p-8 flex-1">
            <!-- Sidebar (Prompt Panel) -->
            <aside class="sidebar flex flex-col gap-4 bg-[var(--color-panel-bg)] rounded-2xl shadow-xl p-6 w-full md:w-[400px]" id="sidebar">
                <div class="sidebar-header flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-extrabold tracking-wide text-purple-400 drop-shadow-lg">PranAI Studio</h2>
                    <button id="themeToggle" aria-label="Toggle Theme" class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-700 hover:bg-gray-600 text-2xl transition-all">☀️</button>
                </div>
                <p class="text-gray-400 leading-relaxed">Enter a descriptive prompt to generate a stunning AI-powered image. The more details you provide, the better your result!</p>
                <textarea id="promptInput" placeholder="e.g., A futuristic neon city skyline at night with flying cars" class="prompt-box w-full h-40 p-4 rounded-xl border-2 border-[var(--color-primary-dark)] bg-gray-800 text-white resize-none focus:outline-none focus:ring-4 focus:ring-purple-400 transition-all"></textarea>
                <button id="generateBtn" disabled class="w-full py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-purple-700 text-white shadow-md hover:shadow-lg hover:scale-[1.02] transition-all">GENERATE IMAGE</button>
                <button id="copyPromptBtn" class="text-[var(--color-primary)] font-semibold hover:text-purple-300 transition-colors">COPY PROMPT</button>
            </aside>

            <!-- Main Image Display -->
            <section class="image-area flex-1 flex justify-center items-center bg-[var(--color-panel-bg)] rounded-2xl shadow-xl overflow-hidden relative p-4" id="imageArea">
                <div class="image-display w-full h-full flex justify-center items-center border-2 border-dashed border-[var(--color-border)] rounded-xl relative">
                    <div id="loadingState" class="hidden flex flex-col items-center gap-4">
                        <div class="loading-spinner rounded-full w-14 h-14 animate-spin"></div>
                        <p class="loading-message text-gray-400 italic">PranAI is generating your masterpiece...</p>
                    </div>
                    <img id="generatedImage" src="" alt="Generated Image" class="hidden max-w-full max-h-full rounded-lg shadow-lg transition-opacity duration-700">
                    <p id="placeholderText" class="text-gray-500 italic">Your generated image will appear here.</p>
                    <p id="errorMessage" class="error-message text-red-400 font-semibold hidden"></p>
                </div>
            </section>
        </div>
        <div class="bottom-tabs fixed bottom-0 left-0 w-full flex justify-around bg-[var(--color-panel-bg)] p-2 md:hidden border-t border-[var(--color-border)]">
            <button id="tabPrompt" class="flex-1 py-2 text-center text-sm">Prompt</button>
            <button id="tabPreview" class="flex-1 py-2 text-center text-sm">Preview</button>
        </div>
    </main>

<script>
// --- GLOBAL ELEMENTS & CONSTANTS ---
const apiKey = ""; // API key is intentionally left blank for security
const sidebar = document.getElementById('sidebar');
const imageArea = document.getElementById('imageArea');
const promptInput = document.getElementById('promptInput');
const generateBtn = document.getElementById('generateBtn');
const copyPromptBtn = document.getElementById('copyPromptBtn');
const generatedImageDisplay = document.getElementById('generatedImage');
const loadingState = document.getElementById('loadingState');
const placeholderText = document.getElementById('placeholderText');
const errorMessage = document.getElementById('errorMessage');
const themeToggle = document.getElementById('themeToggle');
const body = document.body;

// NEW ELEMENTS FOR LANDING PAGE LOGIC
const landingPage = document.getElementById('landing-page');
const authContainer = document.getElementById('auth-container');
const protectedContent = document.getElementById('protected-content');
const ctaBtn = document.getElementById('ctaBtn');

const tabPrompt = document.getElementById('tabPrompt');
const tabPreview = document.getElementById('tabPreview');

// --- UTILITY FUNCTIONS ---

function showLoading(show) {
    if (show) {
        loadingState.classList.remove('hidden');
        generatedImageDisplay.classList.add('hidden');
        placeholderText.classList.add('hidden');
        errorMessage.classList.add('hidden');
    } else {
        loadingState.classList.add('hidden');
    }
}

// 🔹 Disable/enable buttons during generation
function toggleButtons(disabled) {
    generateBtn.disabled = disabled || promptInput.value.trim() === '';
    copyPromptBtn.disabled = disabled;
}

// Mobile tab switching
function activateTab(tab) {
    tabPrompt.classList.remove('active');
    tabPreview.classList.remove('active');
    sidebar.classList.remove('active');
    imageArea.classList.remove('active');

    if (tab === 'prompt') {
        tabPrompt.classList.add('active');
        sidebar.classList.add('active');
    } else {
        tabPreview.classList.add('active');
        imageArea.classList.add('active');
    }
}

// --- CLERK DISPLAY MANAGEMENT ---

// Function to control which main section is visible
function displayApp(user) {
    // Hide all sections first
    protectedContent.classList.add("hidden");
    landingPage.classList.add("hidden");
    authContainer.classList.add("hidden");

    if (user) {
        // State 1: Logged In - Show main content
        protectedContent.classList.remove("hidden");
    } else {
        // State 2: Logged Out - Show the landing page by default
        landingPage.classList.remove("hidden");
    }
}

// --- IMAGE GENERATION LOGIC ---

// Implementing basic exponential backoff for API calls
async function fetchWithBackoff(url, options) {
    const MAX_RETRIES = 3;
    let delay = 1000;

    for (let i = 0; i < MAX_RETRIES; i++) {
        try {
            const response = await fetch(url, options);
            if (!response.ok && response.status === 429 && i < MAX_RETRIES - 1) {
                // Rate limited, wait and retry
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2; // Exponential increase
                continue;
            }
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            if (i === MAX_RETRIES - 1) {
                throw error;
            }
            // Wait before retrying on general error
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
        }
    }
}

async function generateImage() {
    const prompt = promptInput.value.trim();
    if (!prompt) return;

    toggleButtons(true);
    showLoading(true);

    try {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
        const payload = {
             contents: [{ parts: [{ text: prompt }] }],
             generationConfig: { responseModalities: ['TEXT','IMAGE'] }
        };

        const result = await fetchWithBackoff(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

        if (base64Data) {
            generatedImageDisplay.src = `data:image/png;base64,${base64Data}`;
            generatedImageDisplay.classList.remove('hidden');
            placeholderText.classList.add('hidden');
            // Switch to preview tab on mobile after successful generation
            if (window.innerWidth < 768) {
                 activateTab('preview');
            }
        } else {
            errorMessage.textContent = "No image generated. Try a different prompt.";
            errorMessage.classList.remove('hidden');
        }
    } catch (err) {
        errorMessage.textContent = "Image generation failed. Please try again.";
        console.error(err);
    } finally {
        toggleButtons(false);
        showLoading(false);
    }
}

// --- EVENT LISTENERS & INITIALIZATION ---

document.addEventListener('DOMContentLoaded', () => {
    // Theme setup
    const savedTheme = localStorage.getItem('theme');
    const isLight = savedTheme === 'light';

    if (isLight) {
        body.classList.add('light-mode');
        themeToggle.textContent = '🌙';
    } else {
        themeToggle.textContent = '☀️';
    }

    // Mobile default: show prompt tab if logged in
    if (window.innerWidth < 768) {
        activateTab('prompt');
    }

    promptInput.addEventListener('input', () => {
        generateBtn.disabled = promptInput.value.trim() === '';
    });

    generateBtn.addEventListener('click', generateImage);
    tabPrompt.addEventListener('click', () => activateTab('prompt'));
    tabPreview.addEventListener('click', () => activateTab('preview'));

    themeToggle.addEventListener('click', () => {
        body.classList.toggle('light-mode');
        const isLight = body.classList.contains('light-mode');
        themeToggle.textContent = isLight ? '🌙' : '☀️';
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
    });

    copyPromptBtn.addEventListener('click', () => {
        try {
            document.execCommand('copy', false, promptInput.value);
            // Optionally show a quick success message here
        } catch (e) {
            console.error("Copy failed:", e);
        }
    });

    // Landing Page CTA: Switch from Landing Page to Auth Form
    ctaBtn.addEventListener('click', () => {
        landingPage.classList.add("hidden");
        authContainer.classList.remove("hidden");
    });
});


window.addEventListener("load", async () => {
    await Clerk.load();

    // Set initial display based on login state
    displayApp(Clerk.user);

    // Mount the Clerk SignIn form into the auth container (space theme 🌌)
    // We mount it once, and only show its container when needed.
    Clerk.mountSignIn(document.getElementById("clerk-sign-in-form"), {
        appearance: {
            elements: {
                card: "bg-gradient-to-br from-[#1a102b] to-[#0b0f24] border border-purple-700/40 shadow-xl rounded-2xl p-6",
                headerTitle: "text-3xl font-extrabold text-purple-400 tracking-wide drop-shadow-lg",
                headerSubtitle: "text-gray-400 italic",
                formButtonPrimary:
                    "bg-gradient-to-r from-purple-500 via-fuchsia-600 to-pink-600 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:scale-[1.05] hover:shadow-purple-500/50 transition-all",
                formFieldInput:
                    "bg-[#0f172a] border border-purple-600/40 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:ring-2 focus:ring-fuchsia-500",
                footerActionLink:
                    "text-purple-400 hover:text-fuchsia-300 font-semibold transition-colors",
                socialButtonsBlockButton:
                    "bg-[#111827] border border-purple-500/40 text-purple-300 rounded-lg px-4 py-2 hover:bg-purple-900/30 hover:text-white transition-all",
            },
            layout: {
                socialButtonsPlacement: "bottom",
                logoPlacement: "none",
            },
            variables: {
                colorPrimary: "#a855f7",
                colorBackground: "transparent",
                colorText: "#e5e7eb",
            },
        },
        signUpUrl: "/sign-up",
    });

    // Mount the user button in the header (space theme 👨‍🚀)
    Clerk.mountUserButton(document.getElementById("clerk-user-button"), {
        appearance: {
            elements: {
                avatarBox:
                    "ring-2 ring-purple-500 hover:ring-fuchsia-400 transition-all shadow-md",
                userButtonPopoverCard:
                    "bg-gradient-to-br from-[#1a102b] to-[#0b0f24] border border-purple-700/40 rounded-xl shadow-2xl",
                userButtonPopoverActionButton:
                    "hover:bg-purple-800/40 text-purple-200 px-3 py-2 rounded-lg transition-all",
            },
        },
    });

    // Listen for sign in/out events and update display
    Clerk.addListener(({ user }) => {
        displayApp(user);
    });
});
</script>


</body>
</html>
