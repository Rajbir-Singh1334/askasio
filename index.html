<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PranAI - AI Image Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Clerk Frontend SDK -->
  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZXBpYy1haXJlZGFsZS02MS5jbGVyay5hY2NvdW50cy5kZXYk"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>

  <style>
    /* Updated color variables for PranAI branding */
    :root {
      --color-dark-bg: #151026; /* Darker Space Blue */
      --color-panel-bg: #1e1735; /* Panel Blue-Purple */
      --color-primary: #8a2be2; /* BlueViolet / Main Accent */
      --color-primary-dark: #6a1b9a; /* Darker Purple */
      --color-text-light: #d1d5db;
      --color-border: #4b4864;
      --transition-fast: 0.3s ease;
      --transition-slow: 0.6s ease;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--color-dark-bg);
      margin: 0;
      padding: 0;
      color: var(--color-text-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background var(--transition-slow);
    }
    .landing-gradient {
        background-image: linear-gradient(135deg, var(--color-dark-bg) 0%, #1a0f3d 100%);
    }
    .landing-cta-button {
        box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
    }

    /* Existing styles for responsiveness and theme */
    @media (min-width: 768px) {
      .bottom-tabs { display: none !important; }
      #sidebar { display: flex !important; }
      #imageArea { display: flex !important; }
    }
    @media (max-width: 767px) {
      #sidebar { display: flex; }
      #imageArea { display: none; }
    }
    .bottom-tabs button.active {
      color: white !important;
      background-color: var(--color-primary);
    }
    .bottom-tabs button {
      transition: background var(--transition-fast), color var(--transition-fast);
      border-radius: 6px;
    }
    body:not(.light-mode) .bottom-tabs button {
      color: white;
    }
    body.light-mode .bottom-tabs button {
      color: black;
    }
    .loading-spinner {
      border-width: 6px;
      border-style: solid;
      border-color: rgba(255,255,255,0.2);
      border-top-color: var(--color-primary);
    }
    #generatedImage {
      box-shadow: 0 0 20px rgba(138, 43, 226, 0.7);
    }
    
    /* Light Mode Styles */
    body.light-mode {
      background: #f3f4f6;
      color: #1f2937;
    }
    body.light-mode .sidebar { background: #ffffff; }
    body.light-mode #promptInput { background: #ffffff; color: #111827; border-color: #d1d5db; }
    body.light-mode #imageArea { background: #ffffff; border-color: #d1d5db; }
    body.light-mode #placeholderText { color: #6b7280; }
    body.light-mode #generateBtn { background: linear-gradient(to right, #6366f1, #4f46e5); }
    body.light-mode #copyPromptBtn { color: #4f46e5; }
    body.light-mode .image-display { border-color: #d1d5db; }
    body.light-mode #errorMessage { color: #dc2626; }
    body.light-mode header { background: #ffffff; }
    body.light-mode #themeToggle { background: #e5e7eb; color: #1f2937; }
    body.light-mode #themeToggle:hover { background: #d1d5db; }
    body.light-mode .sidebar { background: #e5e7eb; }
    @media (max-width: 767px) {
      #sidebar, #imageArea { display: none; }
      #sidebar.active, #imageArea.active { display: flex !important; }
    }
    /* Ensure the public view takes up full space */
    #public-view { display: none; }
  </style>
</head>
<body>
  <!-- Header (Only visible when LOGGED IN) -->
  <header id="app-header" class="flex justify-between items-center p-4 bg-[var(--color-panel-bg)] hidden">
    <h1 class="text-2xl font-extrabold text-[var(--color-primary)] tracking-wider">PranAI</h1>
    <div class="flex items-center gap-4">
      <div id="clerk-user-button"></div>
    </div>
  </header>

  <!-- Landing Page (Public View) - Visible when LOGGED OUT -->
  <div id="public-view" class="flex-1 landing-gradient hidden flex-col justify-center items-center p-8">
    <div class="text-center max-w-2xl w-full p-8 bg-[var(--color-panel-bg)]/80 backdrop-blur-sm rounded-3xl shadow-2xl transition-all duration-500">
      <h1 class="text-6xl font-extrabold text-[var(--color-primary)] tracking-tight mb-4 sm:text-7xl">PranAI</h1>
      <p class="text-xl mb-10 text-gray-300 sm:text-2xl">Unleash your imagination. Generate stunning, photorealistic art in seconds using the power of AI.</p>
      
      <!-- Call to Action Button to trigger sign-in -->
      <button id="cta-start-generating" class="landing-cta-button py-4 px-10 rounded-xl font-bold text-lg bg-gradient-to-r from-[var(--color-primary)] to-fuchsia-500 text-white hover:scale-[1.05] transition-all duration-300">
        Start Creating for Free
      </button>

      <!-- Clerk Sign-In Form container (hidden by default, shown by CTA) -->
      <div id="clerk-sign-in-form-container" class="mt-8 hidden">
        <!-- Clerk will mount the Sign In/Up form here -->
        <div id="clerk-sign-in-form"></div>
      </div>
    </div>
  </div>
  
  <!-- Protected Content (Image Generator Studio) - Only visible when LOGGED IN -->
  <main id="protected-content" class="flex-1 hidden">
    <div class="main-layout flex flex-col md:flex-row gap-4 p-4 md:p-8 h-full">
      <!-- Sidebar (Prompt Panel) -->
      <aside class="sidebar flex flex-col gap-4 bg-[var(--color-panel-bg)] rounded-2xl shadow-lg p-6 w-full md:w-[400px]" id="sidebar">
        <div class="sidebar-header flex justify-between items-center mb-4">
          <h2 class="text-3xl font-extrabold tracking-wide drop-shadow-lg text-[var(--color-primary)]">PranAI Studio</h2>
          <button id="themeToggle" aria-label="Toggle Theme" class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-700 hover:bg-gray-600 text-2xl transition-all">☀️</button>
        </div>
        <p class="text-gray-400 leading-relaxed">Enter a descriptive prompt to generate a stunning AI-powered image. The more details you provide, the better your result!</p>
        <textarea id="promptInput" placeholder="e.g., A majestic dragon soaring over a glowing futuristic city at sunset, digital art" class="prompt-box w-full h-40 p-4 rounded-xl border-2 border-[var(--color-primary-dark)] bg-gray-800 text-white resize-none focus:outline-none focus:ring-4 focus:ring-purple-400 transition-all"></textarea>
        <button id="generateBtn" disabled class="w-full py-3 rounded-xl font-semibold bg-gradient-to-r from-[var(--color-primary)] to-fuchsia-600 text-white shadow-md hover:shadow-lg hover:scale-[1.02] transition-all">GENERATE IMAGE</button>
        <button id="copyPromptBtn" class="text-[var(--color-primary)] font-semibold hover:text-purple-300 transition-colors">COPY PROMPT</button>
      </aside>

      <!-- Main Image Display -->
      <section class="image-area flex-1 flex justify-center items-center bg-[var(--color-panel-bg)] rounded-2xl shadow-lg overflow-hidden relative p-4" id="imageArea">
        <div class="image-display w-full h-full flex justify-center items-center border-2 border-dashed border-[var(--color-border)] rounded-xl relative">
          <div id="loadingState" class="hidden flex flex-col items-center gap-4">
            <div class="loading-spinner border-6 border-gray-600 border-t-[var(--color-primary)] rounded-full w-14 h-14 animate-spin"></div>
            <p class="loading-message text-gray-400 italic">Generating your masterpiece...</p>
          </div>
          <img id="generatedImage" src="" alt="Generated Image" class="hidden max-w-full max-h-full rounded-lg shadow-lg transition-opacity duration-700">
          <p id="placeholderText" class="text-gray-500 italic">Your generated image will appear here.</p>
          <p id="errorMessage" class="error-message text-red-400 font-semibold hidden"></p>
        </div>
      </section>
    </div>
    <!-- Mobile Tabs -->
    <div class="bottom-tabs fixed bottom-0 left-0 w-full flex justify-around bg-[var(--color-panel-bg)] p-2 md:hidden">
      <button id="tabPrompt" class="flex-1 py-2 text-center active">Prompt</button>
      <button id="tabPreview" class="flex-1 py-2 text-center">Preview</button>
    </div>
  </main>
    
<script>
// Helper function to show/hide views based on user state
function updateView(user) {
    const protectedContent = document.getElementById("protected-content");
    const publicView = document.getElementById("public-view");
    const appHeader = document.getElementById("app-header");
    const clerkSignInContainer = document.getElementById("clerk-sign-in-form-container");
    const ctaButton = document.getElementById("cta-start-generating");

    if (user) {
        // Logged In: Show Generator, Hide Landing/Auth
        protectedContent.classList.remove("hidden");
        appHeader.classList.remove("hidden");
        publicView.classList.add("hidden");
    } else {
        // Logged Out: Show Landing/Auth, Hide Generator
        protectedContent.classList.add("hidden");
        appHeader.classList.add("hidden");
        publicView.classList.remove("hidden");
        
        // Reset landing page state: show CTA, hide sign-in form
        clerkSignInContainer.classList.add('hidden');
        ctaButton.classList.remove('hidden');
    }
}

window.addEventListener("load", async () => {
    // 1. Clerk Setup
    await Clerk.load();

    const clerkSignInContainer = document.getElementById("clerk-sign-in-form-container");
    const ctaButton = document.getElementById("cta-start-generating");

    // Initial view update based on authentication status
    updateView(Clerk.user);

    // Mount the Clerk SignIn form 
    Clerk.mountSignIn(document.getElementById("clerk-sign-in-form"), {
        appearance: {
            elements: {
                // Using new PranAI/dark theme colors
                card: "bg-gradient-to-br from-[#1a102b] to-[#0b0f24] border border-purple-700/40 shadow-xl rounded-2xl p-6",
                headerTitle: "text-3xl font-extrabold text-[var(--color-primary)] tracking-wide drop-shadow-lg",
                headerSubtitle: "text-gray-400 italic",
                formButtonPrimary:
                    "bg-gradient-to-r from-[var(--color-primary)] via-fuchsia-600 to-pink-600 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:scale-[1.05] hover:shadow-purple-500/50 transition-all",
                formFieldInput:
                    "bg-[#0f172a] border border-purple-600/40 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:ring-2 focus:ring-fuchsia-500",
                footerActionLink:
                    "text-[var(--color-primary)] hover:text-fuchsia-300 font-semibold transition-colors",
                socialButtonsBlockButton:
                    "bg-[#111827] border border-purple-500/40 text-purple-300 rounded-lg px-4 py-2 hover:bg-purple-900/30 hover:text-white transition-all",
            },
            layout: {
                socialButtonsPlacement: "bottom",
                logoPlacement: "none",
            },
            variables: {
                colorPrimary: "#8a2be2",
                colorBackground: "transparent",
                colorText: "#e5e7eb",
            },
        },
        signUpUrl: "/sign-up",
    });

    // Mount the user button in the header
    Clerk.mountUserButton(document.getElementById("clerk-user-button"), {
        appearance: {
            elements: {
                avatarBox:
                    "ring-2 ring-[var(--color-primary)] hover:ring-fuchsia-400 transition-all shadow-md",
                userButtonPopoverCard:
                    "bg-gradient-to-br from-[#1a102b] to-[#0b0f24] border border-purple-700/40 rounded-xl shadow-2xl",
                userButtonPopoverActionButton:
                    "hover:bg-purple-800/40 text-purple-200 px-3 py-2 rounded-lg transition-all",
            },
        },
    });

    // Handle CTA click: hide CTA and show sign-in form
    ctaButton.addEventListener('click', () => {
        ctaButton.classList.add('hidden');
        clerkSignInContainer.classList.remove('hidden');
    });

    // Listen for sign in/out events
    Clerk.addListener(({ user }) => {
        updateView(user);
    });

    // 2. Image Generation and UI Setup (renamed all Askaio to PranAI)
    const apiKey = ""; // API key is handled by the canvas environment
    const sidebar = document.getElementById('sidebar');
    const imageArea = document.getElementById('imageArea');
    const promptInput = document.getElementById('promptInput');
    const generateBtn = document.getElementById('generateBtn');
    const copyPromptBtn = document.getElementById('copyPromptBtn');
    const generatedImageDisplay = document.getElementById('generatedImage');
    const loadingState = document.getElementById('loadingState');
    const placeholderText = document.getElementById('placeholderText');
    const errorMessage = document.getElementById('errorMessage');
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const tabPrompt = document.getElementById('tabPrompt');
    const tabPreview = document.getElementById('tabPreview');

    function showLoading(show) {
      if (show) {
        loadingState.classList.remove('hidden');
        generatedImageDisplay.classList.add('hidden');
        placeholderText.classList.add('hidden');
        errorMessage.classList.add('hidden');
      } else {
        loadingState.classList.add('hidden');
      }
    }

    function toggleButtons(disabled) {
      generateBtn.disabled = disabled || promptInput.value.trim() === '';
      copyPromptBtn.disabled = disabled;
    }

    // Theme loading logic
    const savedTheme = localStorage.getItem('theme');

    if (!savedTheme || savedTheme === 'light') {
      body.classList.add('light-mode');
      themeToggle.textContent = '🌙';
      localStorage.setItem('theme', 'light');
    } else {
      themeToggle.textContent = '☀️';
    }

    document.querySelectorAll('.bottom-tabs button').forEach(btn => {
      btn.style.color = (!savedTheme || savedTheme === 'light') ? 'black' : 'white';
    });

    promptInput.addEventListener('input', () => {
      toggleButtons(false);
    });

    if (window.innerWidth < 768) {
      activateTab('prompt');
    }

    themeToggle.addEventListener('click', () => {
      body.classList.toggle('light-mode');
      const isLight = body.classList.contains('light-mode');
      themeToggle.textContent = isLight ? '🌙' : '☀️';
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
      document.querySelectorAll('.bottom-tabs button').forEach(btn => {
        btn.style.color = isLight ? 'black' : 'white';
      });
    });

    copyPromptBtn.addEventListener('click', () => {
      if (promptInput.value.trim()) {
        // Use document.execCommand('copy') for better compatibility in iframes
        document.execCommand('copy', false, promptInput.value.trim());
      }
    });

    async function generateImage() {
      const prompt = promptInput.value.trim();
      if (!prompt) return;

      toggleButtons(true);
      showLoading(true);

      // Simple retry mechanism with exponential backoff
      const maxRetries = 3;
      let delay = 1000;
      let base64Data = null;

      for (let i = 0; i < maxRetries; i++) {
        try {
          // Using imagen-3.0-generate-002 as the preferred model for image generation
          const modelName = 'imagen-3.0-generate-002';
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:predict?key=${apiKey}`;
          
          const payload = { 
              instances: { prompt: prompt }, 
              parameters: { "sampleCount": 1 } 
          };

          const response = await fetch(apiUrl, { 
              method: 'POST', 
              headers: { 'Content-Type': 'application/json' }, 
              body: JSON.stringify(payload) 
          });
          
          if (!response.ok) {
              // Throw error to trigger retry or final catch
              throw new Error(`API call failed: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
          
          if (base64Data) {
            // Success, break the loop
            break; 
          } else if (i < maxRetries - 1) {
            // No image data but not last attempt, wait and retry
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2; // Exponential backoff
          }

        } catch (err) {
            if (i < maxRetries - 1) {
              await new Promise(resolve => setTimeout(resolve, delay));
              delay *= 2;
            } else {
              // Last attempt failed
              throw err; 
            }
        }
      }

      try {
        if (base64Data) {
          generatedImageDisplay.src = `data:image/png;base64,${base64Data}`;
          generatedImageDisplay.classList.remove('hidden');
          placeholderText.classList.add('hidden');
          errorMessage.classList.add('hidden');
        } else {
          errorMessage.textContent = "No image data was generated after multiple attempts. Try a different prompt.";
          errorMessage.classList.remove('hidden');
          generatedImageDisplay.classList.add('hidden');
          placeholderText.classList.remove('hidden');
        }
      } catch (err) {
        console.error("Final image display error:", err);
        errorMessage.textContent = "Error displaying image: " + (err.message || "Unknown error.");
        errorMessage.classList.remove('hidden');
      } finally {
        toggleButtons(false);
        showLoading(false);
      }
    }

    generateBtn.addEventListener('click', generateImage);

    // Mobile tab switching
    function activateTab(tab) {
      tabPrompt.classList.remove('active');
      tabPreview.classList.remove('active');
      sidebar.classList.remove('active');
      imageArea.classList.remove('active');

      if (tab === 'prompt') {
        tabPrompt.classList.add('active');
        sidebar.classList.add('active');
      } else {
        tabPreview.classList.add('active');
        imageArea.classList.add('active');
      }
    }

    tabPrompt.addEventListener('click', () => activateTab('prompt'));
    tabPreview.addEventListener('click', () => activateTab('preview'));
});
</script>
</body>
</html>
