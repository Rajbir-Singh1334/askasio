<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Askaio - AI Image Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Clerk Frontend SDK -->
  <script 
    async 
    crossorigin="anonymous" 
    data-clerk-publishable-key="pk_test_ZXBpYy1haXJlZGFsZS02MS5jbGVyay5hY2NvdW50cy5kZXYk" 
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>

  <style>
    :root {
      --color-dark-bg: #211e2f;
      --color-panel-bg: #2b283d;
      --color-primary: #ecddfa;
      --color-primary-dark: #9333ea;
      --color-text-light: #d1d5db;
      --color-border: #4b4864;
      --transition-fast: 0.3s ease;
      --transition-slow: 0.6s ease;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--color-dark-bg);
      margin: 0;
      padding: 0;
      color: var(--color-text-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="flex justify-between items-center p-4 bg-[var(--color-panel-bg)]">
    <h1 class="text-xl font-bold">Askaio</h1>
    <div class="flex items-center gap-4">
      <div id="clerk-sign-in"></div>
      <div id="clerk-user-button"></div>
    </div>
  </header>

  <!-- Protected Content (only visible when logged in) -->
  <main id="protected-content" class="flex-1 hidden">
    <div class="main-layout flex flex-col md:flex-row gap-4 p-4 md:p-8">
      <!-- Sidebar (Prompt Panel) -->
      <aside class="sidebar flex flex-col gap-4 bg-[var(--color-panel-bg)] rounded-2xl shadow-lg p-6 w-full md:w-[400px]" id="sidebar">
        <div class="sidebar-header flex justify-between items-center mb-4">
          <h1 class="text-4xl font-extrabold tracking-wide drop-shadow-lg">Askaio</h1>
          <button id="themeToggle" aria-label="Toggle Theme" class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-700 hover:bg-gray-600 text-2xl transition-all">☀️</button>
        </div>
        <p class="text-gray-400 leading-relaxed">Enter a descriptive prompt to generate a stunning AI-powered image. The more details you provide, the better your result!</p>
        <textarea id="promptInput" placeholder="e.g., A futuristic neon city skyline at night with flying cars" class="prompt-box w-full h-40 p-4 rounded-xl border-2 border-[var(--color-primary-dark)] bg-gray-800 text-white resize-none focus:outline-none focus:ring-4 focus:ring-purple-400 transition-all"></textarea>
        <button id="generateBtn" disabled class="w-full py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-purple-700 text-white shadow-md hover:shadow-lg hover:scale-[1.02] transition-all">GENERATE IMAGE</button>
        <button id="copyPromptBtn" class="text-[var(--color-primary)] font-semibold hover:text-purple-300 transition-colors">COPY PROMPT</button>
      </aside>

      <!-- Main Image Display -->
      <main class="image-area flex-1 flex justify-center items-center bg-[var(--color-panel-bg)] rounded-2xl shadow-lg overflow-hidden relative p-4" id="imageArea">
        <div class="image-display w-full h-full flex justify-center items-center border-2 border-dashed border-[var(--color-border)] rounded-xl relative">
          <div id="loadingState" class="hidden flex flex-col items-center gap-4">
            <div class="loading-spinner border-6 border-gray-600 border-t-[var(--color-primary)] rounded-full w-14 h-14 animate-spin"></div>
            <p class="loading-message text-gray-400 italic">Generating your masterpiece...</p>
          </div>
          <img id="generatedImage" src="" alt="Generated Image" class="hidden max-w-full max-h-full rounded-lg shadow-lg transition-opacity duration-700">
          <p id="placeholderText" class="text-gray-500 italic">Your generated image will appear here.</p>
          <p id="errorMessage" class="error-message text-red-400 font-semibold hidden"></p>
        </div>
      </main>
    </div>
    <div class="bottom-tabs fixed bottom-0 left-0 w-full flex justify-around bg-[var(--color-panel-bg)] p-2 md:hidden">
      <button id="tabPrompt" class="flex-1 py-2 text-center active">Prompt</button>
      <button id="tabPreview" class="flex-1 py-2 text-center">Preview</button>
    </div>
  </main>

  <!-- Public Auth Page (when logged out) -->
  <div id="public-auth" class="flex-1 hidden flex justify-center items-center p-4">
    
    <!-- Landing Page: Initial View -->
    <div id="public-landing" class="max-w-md w-full p-8 md:p-12 bg-[var(--color-panel-bg)] rounded-3xl shadow-2xl flex flex-col items-center space-y-8">
        <h2 class="text-4xl font-extrabold text-[var(--color-primary)] tracking-tight text-center">Welcome to Askaio</h2>
        <p class="text-gray-400 text-center text-lg">Generate stunning AI images. Please log in or sign up to continue.</p>
        
        <div class="flex flex-col space-y-4 w-full">
            <button id="showSignIn" class="w-full py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-fuchsia-600 text-white shadow-lg hover:shadow-purple-500/50 hover:scale-[1.02] transition-all">
                Login
            </button>
            <button id="showSignUp" class="w-full py-3 rounded-xl font-semibold border-2 border-purple-500 text-purple-300 hover:bg-purple-900/20 hover:text-white transition-all">
                Sign Up
            </button>
        </div>
    </div>
    
    <!-- Clerk Form Container: Only shown when a button is clicked -->
    <div id="clerk-form-container" class="hidden w-full max-w-md"></div>
  </div>


<style>
@media (min-width: 768px) {
  .bottom-tabs { display: none !important; }
  #sidebar { display: flex !important; }
  #imageArea { display: flex !important; }
}
@media (max-width: 767px) {
  #sidebar { display: flex; }
  #imageArea { display: none; }
}
.bottom-tabs button.active {
  color: white;
  background-color: var(--color-primary);
}
.bottom-tabs button {
  transition: background var(--transition-fast), color var(--transition-fast);
}
.bottom-tabs button:hover {
  background-color: rgba(255,255,255,0.05);
}
@media (max-width: 767px) {
  #sidebar { display: flex; }
  #imageArea { display: none; }
  .bottom-tabs { display: flex; }
}

.bottom-tabs button.active {
  color: white;
  background-color: var(--color-primary);
}
.bottom-tabs button {
  transition: background var(--transition-fast), color var(--transition-fast);
  border-radius: 6px;
}

/* Dark mode text color */
body:not(.light-mode) .bottom-tabs button {
  color: white;
}

/* Light mode text color */
body.light-mode .bottom-tabs button {
  color: black;
}

/* Active tab style */
.bottom-tabs button.active {
  color: white !important; /* always white on active */
  background-color: var(--color-primary);
}
.loading-spinner {
  border-width: 6px;
  border-style: solid;
  border-color: rgba(255,255,255,0.2);
  border-top-color: var(--color-primary);
}
#generatedImage {
  box-shadow: 0 0 20px rgba(168, 85, 247, 0.7);
}
body.light-mode {
  background: #f3f4f6;
  color: #1f2937;
}

body.light-mode .sidebar {
  background: #ffffff;
}

body.light-mode #promptInput {
  background: #ffffff;
  color: #111827;
  border-color: #d1d5db;
}

body.light-mode #imageArea {
  background: #ffffff;
  border-color: #d1d5db;
}

body.light-mode #placeholderText {
  color: #6b7280;
}

body.light-mode #generateBtn {
  background: linear-gradient(to right, #6366f1, #4f46e5);
}

body.light-mode #copyPromptBtn {
  color: #4f46e5;
}

body.light-mode .image-display {
  border-color: #d1d5db;
}

body.light-mode #errorMessage {
  color: #dc2626;
}
body.light-mode header {
  background: #ffffff;
}
body.light-mode #themeToggle {
  background: #e5e7eb; /* light gray */
  color: #1f2937; /* dark text */
}
body.light-mode #themeToggle:hover {
  background: #d1d5db; /* slightly darker gray */
}

body.light-mode .sidebar {
  background: #e5e7eb;
}
@media (max-width: 767px) {
  #sidebar, #imageArea {
    display: none;
  }
  #sidebar.active, #imageArea.active {
    display: flex !important;
  }
}
</style>
<script>
// Define the custom Clerk appearance once
const clerkAppearance = {
    elements: {
        card: "bg-gradient-to-br from-[#1a102b] to-[#0b0f24] border border-purple-700/40 shadow-xl rounded-2xl p-6",
        headerTitle: "text-3xl font-extrabold text-purple-400 tracking-wide drop-shadow-lg",
        headerSubtitle: "text-gray-400 italic",
        formButtonPrimary: 
            "bg-gradient-to-r from-purple-500 via-fuchsia-600 to-pink-600 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:scale-[1.05] hover:shadow-purple-500/50 transition-all",
        formFieldInput: 
            "bg-[#0f172a] border border-purple-600/40 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:ring-2 focus:ring-fuchsia-500",
        footerActionLink: 
            "text-purple-400 hover:text-fuchsia-300 font-semibold transition-colors",
        socialButtonsBlockButton: 
            "bg-[#111827] border border-purple-500/40 text-purple-300 rounded-lg px-4 py-2 hover:bg-purple-900/30 hover:text-white transition-all",
    },
    layout: {
        socialButtonsPlacement: "bottom",
        logoPlacement: "none",
    },
    variables: {
        colorPrimary: "#a855f7",
        colorBackground: "transparent",
        colorText: "#e5e7eb",
    },
};

// New elements for the auth gateway
const publicLanding = document.getElementById("public-landing");
const clerkFormContainer = document.getElementById("clerk-form-container");
const showSignInBtn = document.getElementById("showSignIn");
const showSignUpBtn = document.getElementById("showSignUp");

/**
 * Hides the landing page and mounts the appropriate Clerk form (Sign In or Sign Up).
 * @param {'signIn' | 'signUp'} type - The type of form to mount.
 */
function showForm(type) {
    // Hide the landing page and show the form container
    publicLanding.classList.add("hidden");
    clerkFormContainer.classList.remove("hidden");
    clerkFormContainer.innerHTML = ''; // Clear previous mount

    if (type === 'signIn') {
        Clerk.mountSignIn(clerkFormContainer, {
            appearance: clerkAppearance,
            // Ensure internal links within the Clerk form switch views correctly
            initialState: {
                onSwitchToSignUp: () => showForm('signUp') 
            }
        });
    } else { // type === 'signUp'
        Clerk.mountSignUp(clerkFormContainer, {
            appearance: clerkAppearance,
            // Ensure internal links within the Clerk form switch views correctly
            initialState: {
                onSwitchToSignIn: () => showForm('signIn')
            }
        });
    }
}

window.addEventListener("load", async () => {
  await Clerk.load();

  if (!Clerk.user) {
    document.getElementById("protected-content").classList.add("hidden");
    document.getElementById("public-auth").classList.remove("hidden");

    // Start by showing the friendly landing page
    publicLanding.classList.remove("hidden");
    clerkFormContainer.classList.add("hidden");
    
    // Attach event listeners to the new buttons
    if (showSignInBtn) showSignInBtn.addEventListener('click', () => showForm('signIn'));
    if (showSignUpBtn) showSignUpBtn.addEventListener('click', () => showForm('signUp'));
  } else {
    document.getElementById("protected-content").classList.remove("hidden");
    document.getElementById("public-auth").classList.add("hidden");
  }

  // Mount the user button in the header (space theme 👨‍🚀)
  Clerk.mountUserButton(document.getElementById("clerk-user-button"), {
    appearance: {
      elements: {
        avatarBox:
          "ring-2 ring-purple-500 hover:ring-fuchsia-400 transition-all shadow-md",
        userButtonPopoverCard:
          "bg-gradient-to-br from-[#1a102b] to-[#0b0f24] border border-purple-700/40 rounded-xl shadow-2xl",
        userButtonPopoverActionButton:
          "hover:bg-purple-800/40 text-purple-200 px-3 py-2 rounded-lg transition-all",
      },
    },
  });

  // Listen for sign in/out events
  Clerk.addListener(({ user }) => {
    if (user) {
      document.getElementById("protected-content").classList.remove("hidden");
      document.getElementById("public-auth").classList.add("hidden");
      publicLanding.classList.remove("hidden"); // Reset state
      clerkFormContainer.classList.add("hidden");
    } else {
      document.getElementById("protected-content").classList.add("hidden");
      document.getElementById("public-auth").classList.remove("hidden");
      // Show landing page again on sign out
      publicLanding.classList.remove("hidden"); 
      clerkFormContainer.classList.add("hidden");
    }
  });
});

const apiKey = "AIzaSyD8xBXpp0FYeV0nCxZ9V_VtVjKwoo6_BUw";
const sidebar = document.getElementById('sidebar');
const imageArea = document.getElementById('imageArea');
const promptInput = document.getElementById('promptInput');
const generateBtn = document.getElementById('generateBtn');
const copyPromptBtn = document.getElementById('copyPromptBtn');
const generatedImageDisplay = document.getElementById('generatedImage');
const loadingState = document.getElementById('loadingState');
const placeholderText = document.getElementById('placeholderText');
const errorMessage = document.getElementById('errorMessage');
const themeToggle = document.getElementById('themeToggle');
const body = document.body;

const tabPrompt = document.getElementById('tabPrompt');
const tabPreview = document.getElementById('tabPreview');

function showLoading(show) {
  if (show) {
    loadingState.classList.remove('hidden');
    generatedImageDisplay.classList.add('hidden');
    placeholderText.classList.add('hidden');
    errorMessage.classList.add('hidden');
  } else {
    loadingState.classList.add('hidden');
  }
}

// 🔹 Disable/enable buttons during generation
function toggleButtons(disabled) {
  generateBtn.disabled = disabled || promptInput.value.trim() === '';
  copyPromptBtn.disabled = disabled;
}

document.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('theme');

  // Default theme logic
  if (!savedTheme || savedTheme === 'light') {
    body.classList.add('light-mode');
    themeToggle.textContent = '🌙';
    localStorage.setItem('theme', 'light');
  } else {
    themeToggle.textContent = '☀️';
  }

  // Set bottom tab text colors on load
  document.querySelectorAll('.bottom-tabs button').forEach(btn => {
    btn.style.color = (!savedTheme || savedTheme === 'light') ? 'black' : 'white';
  });

  promptInput.addEventListener('input', () => {
    generateBtn.disabled = promptInput.value.trim() === '';
  });

  // Mobile default: show prompt tab
  if (window.innerWidth < 768) {
    activateTab('prompt');
  }
});

themeToggle.addEventListener('click', () => {
  body.classList.toggle('light-mode');
  const isLight = body.classList.contains('light-mode');
  themeToggle.textContent = isLight ? '🌙' : '☀️';
  localStorage.setItem('theme', isLight ? 'light' : 'dark');

  // Update bottom tab text colors instantly
  document.querySelectorAll('.bottom-tabs button').forEach(btn => {
    btn.style.color = isLight ? 'black' : 'white';
  });
});

copyPromptBtn.addEventListener('click', () => {
  /* Use document.execCommand('copy') for robust clipboard operation in iFrame environments */
  const textArea = document.createElement("textarea");
  textArea.value = promptInput.value;
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
      document.execCommand('copy');
  } catch (err) {
      console.error('Failed to copy text: ', err);
  }
  document.body.removeChild(textArea);
});

async function generateImage() {
  const prompt = promptInput.value.trim();
  if (!prompt) return;

  toggleButtons(true); // disable both
  showLoading(true);

  // Simple retry mechanism with exponential backoff
  const maxRetries = 3;
  let attempt = 0;
  let success = false;
  let base64Data = null;
  let lastError = null;

  while (attempt < maxRetries && !success) {
      try {
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent?key=${apiKey}`;
          const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseModalities: ['TEXT','IMAGE'] } };
          const response = await fetch(apiUrl, { 
              method: 'POST', 
              headers: { 'Content-Type': 'application/json' }, 
              body: JSON.stringify(payload) 
          });
          
          if (!response.ok) {
              throw new Error(`API returned status ${response.status}`);
          }
          
          const result = await response.json();
          base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
          
          if (base64Data) {
              success = true;
          } else {
              throw new Error("No image data found in response.");
          }
      } catch (err) {
          lastError = err;
          attempt++;
          if (attempt < maxRetries) {
              const delay = Math.pow(2, attempt) * 1000; // 2s, 4s, 8s
              await new Promise(resolve => setTimeout(resolve, delay));
          }
      }
  }

  if (base64Data) {
    generatedImageDisplay.src = `data:image/png;base64,${base64Data}`;
    generatedImageDisplay.classList.remove('hidden');
    placeholderText.classList.add('hidden');
    errorMessage.classList.add('hidden');
  } else {
    errorMessage.textContent = `Error generating image. Please try again. Last attempt failed: ${lastError ? lastError.message : 'Unknown error.'}`;
    errorMessage.classList.remove('hidden');
  }

  toggleButtons(false); // re-enable
  showLoading(false);
}

generateBtn.addEventListener('click', generateImage);

// Mobile tab switching
function activateTab(tab) {
  tabPrompt.classList.remove('active');
  tabPreview.classList.remove('active');
  sidebar.classList.remove('active');
  imageArea.classList.remove('active');

  if (tab === 'prompt') {
    tabPrompt.classList.add('active');
    sidebar.classList.add('active');
  } else {
    tabPreview.classList.add('active');
    imageArea.classList.add('active');
  }
}

tabPrompt.addEventListener('click', () => activateTab('prompt'));
tabPreview.addEventListener('click', () => activateTab('preview'));
</script>

</body>
</html>
